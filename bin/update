#!/usr/local/bin/php -q

<? 
require '../inc/lib.inc';
require '../inc/getopt.inc';

$stern_warning = "
WARNING: You are about to copy modified data 
from this database to the actual DNS servers. The DNS servers
are what makes this company and our customers accesible to users 
everywhere on the Internet.

If you have screwed up the contents of the database, the end result
may be the partial or complete disruption of Internet services for
us and/or our customers. Real money may be lost, and real people
may get real upset.

By executing this command with the -f option, you accept full legal, 
financial and moral responsibility for the consequences of your action:
"; 

$push_in_progress = "
%s is already running a push operation. The database is
locked until that process completes. Please be patient, as
a big update can take many minutes to complete.

If this condition persists, or you are otherwise convinced that
an error has occurred, then you can clear the lock condition
on the settings menu.
";


#
# MAIN
#
if ( $LOG_DIR ) {
	if ( !opendir($LOG_DIR) ) {
		die("<H3><FONT color=\"red\">Can not open log directory: $LOG_DIR</FONT></H3>\n");
	};
	closedir();
	$UPDATE_LOG = $LOG_DIR."/".date("YmdHis").".log";
}

$opts = getopts($argv, "f");

$query = "SELECT id, domain, master FROM zones WHERE updated AND domain != 'TEMPLATE' ORDER BY domain";
$rid1 = sql_query($query);
$query = "SELECT domain, zonefile FROM deleted_domains";
$rid2 = sql_query($query);
if ($count = mysql_num_rows($rid1)) {
	print "Found $count domains which have been updated since\n";
	print "the last time this database was synchronized with\n";
	print "the DNS servers.\n";
} 
if ($count = mysql_num_rows($rid2)) {
	print "Found $count domains which have been deleted from\n";
	print "the database since the last synchronization.\n";
}
if (!mysql_num_rows($rid1) && !mysql_num_rows($rid2)) {
	print "Nothing to do.\n";
	exit();
} else {
	if (!$opts['f']) {
		print $stern_warning;
		exit();
	}
}

# !!!
if ($user = patient_enter_crit($REMOTE_USER, 'PUSH')) {
	print sprintf($push_in_progress, ucfirst($user));
	exit();
}

exec("/bin/rm -rf $TMP/master $TMP/slave");
mkdir("$TMP/master", 0755);
mkdir("$TMP/slave",  0755);
if (!chdir("$TMP/master")) 
{
	leave_crit('PUSH'); 
	die("chdir($TMP/master) failed.\n");
}
while ($zone = mysql_fetch_row($rid1)) {
	if ($zone[2])
		adjust_serial($zone[0]); # We don't make zone files for slaves
	else 
		$domains[] = $zone[1];
	if (count($domains) >= 64) {
		$cmd =  "$BIN/mkzonefile -u ".join(" ", $domains);
		exec("$cmd 2>&1 >>$UPDATE_LOG");
		$domains = array();
	}
	print "$zone[1] updated\n";
}
if (count($domains)) {
	$cmd =  "$BIN/mkzonefile -u ".join(" ", $domains);
	exec("$cmd 2>&1 >>$UPDATE_LOG");
}

while ($trash = mysql_fetch_row($rid2)) {
	print "$trash[0] deleted\n";
}
print "\n";
mysql_free_result($rid1);
mysql_free_result($rid2);
$cmd = "$BIN/mkdeadlist -u 2>&1 >> $UPDATE_LOG";
exec("$cmd");

$query = "SELECT hostname, type, pushupdates, script, zonedir FROM servers";
$rid = sql_query($query);
while ($row = mysql_fetch_array($rid)) {
	$server = $row['hostname'];
	$type = $row['type'];
	$update = $row['pushupdates'];
	$script = $row['script'];
	$zonedir = $row['zonedir'];
	if ($update) {
		if ($type == 'M') {
			# This is a master server
			chdir("$TMP/master") || die("$!: $TMP/master\n");
			$cmd = "$BIN/mknamed.conf $server >named.conf";
			exec($cmd);
			print "<br>$cmd<br>\n";
			$cmd = "$SBIN/$script $server $zonedir>>$UPDATE_LOG 2>&1";
			exec($cmd, $out, $ret);
			if ($ret != 0) {
				print "<HR><FONT color=RED>SCRIPT FAILURE,see logs below. Do not forget to make 'Bulk update' when will fix the problem.</FONT><HR>\n";
				$error = 1;
			}
		} else {
			# This must be a slave server then
			chdir("$TMP/slave") || die("$!: $TMP/slave\n");
			$cmd = "$BIN/mknamed.conf $server >named.conf";
			exec($cmd);
			print "<br>$cmd<br>\n";
			$cmd = "$SBIN/$script $server $zonedir>>$UPDATE_LOG 2>&1";
			exec($cmd, $out, $ret);
			if ($ret != 0) {
				print "<HR><FONT color=RED>SCRIPT FAILURE,see logs below. Do not forget to make 'Bulk update' when will fix the problem.</FONT><HR>\n";
				$error = 1;
			}
		}
		print "Updated $server as a ".($type=='M' ? "master" : "slave")."\n";
	} else {
		print "Skipped $server.\n";
	}
}
mysql_free_result($rid);

# !!!
leave_crit('PUSH');
if ($LOG_DIR) {
	print "<H3>LOG file: $UPDATE_LOG</H3>\n<HR>\n<PRE>\n";
	passthru("/bin/cat $UPDATE_LOG");
	print "<HR>\n</PRE>\n";
};
	
print "Done.\n";

?>


